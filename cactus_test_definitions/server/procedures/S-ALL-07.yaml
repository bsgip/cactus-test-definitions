Description: S-ALL-07 Select Edge Cases for Telemetry Reporting
Category: Monitoring
Classes:
 - A

TargetVersions:
 - v1.2

Preconditions:
  required_clients:
    - id: client

Steps:
  - id: PRECONDITION
    repeat_until_pass: true
    instructions:
      - Create an EndDevice registration for client (or rerun S-ALL-01 or S-ALL-02).
      - Complete MirrorUsagePoint creation process (or rerun S-ALL-06).
      - Ensure DER is generating at least 50% of rated active power.
      - Configure utility server with client's Private Enterprise Number (PEN).
    action: 
      type: discovery
      parameters:
        resources:
          - EndDevice
          - DER
          - MirrorUsagePoint
    checks:
      - type: end-device 
        parameters:
          matches_client: true 
      - type: mirror-usage-point
        parameters:
          matches: true
          minimum_count: 1

  - id: Create MUP
    instructions:
      - Post an initial MirrorUsagePoint to be overwritten later.
    action: 
      type: upsert-mup
      parameters:
        mup_id: mup_mrid_1
        location: Device
        reading_types: 
          - ActivePowerAverage
          - VoltageSinglePhaseAverage
        roleFlags: 1
    checks:
      - type: mirror-usage-point
        parameters:
          matches: true
          mup_id: mup_mrid_1
          location: Device
          reading_types: 
            - ActivePowerAverage
            - VoltageSinglePhaseAverage
          roleFlags: 1
# TODO: STEP 1. Make MUP with two types in it
# Update the roleflags of one of them
# STEP 2: Create a reading, then a new reading with the same mrid to overwrite it
# STEP 3: update the MUP type but leave the reading (change votage to frequency)
  - id: UPDATE MUP ROLEFLAGS
    instructions:
      - Post same MirrorUsagePoint mRID with different roleFlags to verify update (not creation).
    action: 
      type: upsert-mup
      parameters:
        mup_id: mup_mrid_1
        location: Device
        reading_types: 
          - ActivePowerAverage
          - VoltageSinglePhaseAverage
        roleFlags: 2
    checks:
      - type: mirror-usage-point
        parameters:
          matches: true
          mup_id: mup_mrid_1
          location: Device
          reading_types: 
            - ActivePowerAverage
            - VoltageSinglePhaseAverage
          mmr_mrids:
            - reading_1
            - reading_2
          roleFlags: 2

  - id: POST INITIAL READING
    action: 
      type: insert-readings
      parameters:
        mup_id: mup_mrid_1
        values:
          ActivePowerAverage: [5000]

  - id: UPDATE READING
    instructions:
      - Post MirrorMeterReading with same mRID but different value to verify update behavior.
    action: 
      type: insert-readings
      parameters:
        mup_id: mup_mrid_1
        values:
          ActivePowerAverage: [6000]
  
  - id: UPDATE READING
    instructions:
      - Post MirrorMeterReading with same mRID and no value.
    action: 
      type: insert-readings
      parameters:
        mup_id: mup_mrid_1
