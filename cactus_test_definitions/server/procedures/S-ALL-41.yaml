Description: Control Responses
Category: Control
Classes:
 - A

TargetVersions:
 - v1.2

Preconditions:
  required_clients:
    - id: client
  
Steps:
  - id: (A) PRECONDITION
    repeat_until_pass: true
    client: client
    instructions:
      - Create an EndDevice registration.
    action: 
      type: discovery
      parameters:
        resources:
          - EndDevice
    checks:
      - type: end-device 
        parameters:
          matches_client: true 

  - id: (1) DERControl 1 - Scheduled
    repeat_until_pass: true
    client: client
    instructions:
      - Configure an active control with opModExpLimW and opModImpLimW = 200% of the DERs rated active power, responseRequired = 03, and replyTo set to the response endpoint on the test utility server.
    action: 
      type: discovery
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          # replyTo should also be set but this check is implicit in later communications
          event_status: 0 # Scheduled
          latest: True
  
  - id: (1b) DERControl 1 - Received
    client: client
    action: 
      type: respond-der-controls # send response status = 1 (received)

  - id: (2) DERControl 1 - Active
    repeat_until_pass: true # Wait until event status has been updated
    client: client
    action: 
      type: discovery
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control # Check event status has been updated
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          event_status: 1 # Active
          latest: True
  
  - id: (2b) DERControl 1 - Started
    client: client
    action: 
      type: respond-der-controls # send response status = 2 (started)
    
  - id: (3) DERControl 1 - Completed
    repeat_until_pass: true # Wait until event status has been updated
    client: client
    action: 
      type: discovery # Update the DER controls
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control # Check event status has been updated
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          event_status: 2 # Completed
          latest: True
  
  - id: (3b) DERControl 1 - Completed
    client: client
    action: 
      type: respond-der-controls # send response status = 3 (Completed)

  - id: (4) DERControl 2
    repeat_until_pass: true
    client: client
    instructions:
      - The utility server is configured with an active control with opModExpLimW and opModImpLimW = 200% of the DERs rated active power, responseRequired = 03 and replyTo set to the response endpoint on the test utility server, to begin in 5 minutes.
    action:
      type: discovery
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          responseRequired: 3
          # replyTo should also be set but this check is implicit in later communications
          event_status: 0 # Scheduled
          # start time should be set to 5 mins but we do not check
          latest: True
  
  - id: (4b) DERControl 2 - Received
    client: client
    action: 
      type: respond-der-controls # send response status = 1 (Received)

  - id: (4c) DERControl 2 - Started
    repeat_until_pass: true # Wait until event status has been updated
    client: client
    action: 
      type: discovery # Update the DER controls
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control # Check event status has been updated
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          event_status: 1 # Active
          latest: True

  - id: (4d) DERControl 2 - Started
    client: client
    action: 
      type: respond-der-controls # send response status = 2 (Started)

  - id: (5) DERControl 2 - Cancelled.
    repeat_until_pass: true
    client: client
    instructions:
      - The utility server is configured to cancel the active control while it is still active.
    action:
      type: discovery # Update the DER controls
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          responseRequired: 3
          event_status: 2 # Cancelled
          latest: True
    
  - id: (5b) DERControl 2 - Respond to cancelled DERControl
    client: client
    action: 
      type: respond-der-controls # Will post control response status = 6 (cancelled).

  - id: (6) DERControl 3
    repeat_until_pass: true
    client: client
    instructions:
      - The utility server is configured with an active control with opModExpLimW and opModImpLimW = 200% of the DERs rated active power, responseRequired = 03 and replyTo set to the response endpoint on the test utility server, to begin in 10 minutes.
    action:
      type: discovery
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          responseRequired: 3
          # replyTo should also be set but this check is implicit in later communications
          event_status: 0 # Scheduled
          # start time should be set to 10 mins but we do not check
          latest: True
  
  - id: (6b) Respond to scheduled DERControl 3
    client: client
    action: 
      type: respond-der-controls # Respond status = 1 (received).

  - id: (7) DERControl 3 - Cancel
    repeat_until_pass: true
    client: client
    instructions:
      - The utility server is configured to cancel the scheduled control before it is active.
    action:
      type: discovery # Update the DER controls
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          responseRequired: 3
          event_status: 2 # Cancelled
          latest: True

  - id: (7b) Respond to cancelled DERControl 3
    client: client
    action: 
      type: respond-der-controls # Will post control response status = 6 (cancelled).

  - id: (8) DERControl 4
    repeat_until_pass: true
    client: client
    instructions:
      - The utility server configures an active control with opModExpLimW and opModImpLimW = 200% of the DERs rated active power to begin in 10 minutes.
    action:
      type: discovery # Update the DER controls
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          event_status: 0 # Scheduled
          latest: True

  - id: (8b) Respond to scheduled DERControl 4
    client: client
    action: 
      type: respond-der-controls # Will post control response status = 1 (received).

  - id: (9) DERControl 5
    repeat_until_pass: true
    client: client
    instructions:
      - The utility server configures an active control with the same primacy and an overlapping control window.
    action:
      type: discovery # Update the DER controls
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          event_status: 0 # Scheduled
          latest: True

  - id: (9b) Respond to scheduled DERControls 4 and 5
    client: client
    action: 
      type: respond-der-controls # Send both: control 4 (7 superseeded), and control 5 (1 scheduled).

  - id: (9c) Check DERControl 4 superseeded
    repeat_until_pass: true
    client: client
    action:
      type: discovery # Update the DER controls
      parameters:
        resources:
          - DERControl
    checks:
      - type: der-control
        parameters:
          opModExpLimW: $(setMaxW * 2)
          opModImpLimW: $(setMaxW * 2)
          event_status: 4 # Superseeded
          minimum_count: 1
          maximum_count: 1
          latest: False # DER control 5 is scheduled, DER control 4 should be superseeded
    